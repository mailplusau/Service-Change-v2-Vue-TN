let data = [
    {
        "internalid": "97576",
        "internalid_text": "97576",
        "id": "94141",
        "id_text": null,
        "custrecord_servicechg_status": "4",
        "custrecord_servicechg_status_text": "Quote",
        "custrecord_servicechg_service": "97576",
        "custrecord_servicechg_service_text": "AMPO 3",
        "custrecord_servicechg_date_effective": "1/12/2023",
        "custrecord_servicechg_date_effective_text": null,
        "custrecord_servicechg_date_emailed": "",
        "custrecord_servicechg_date_emailed_text": null,
        "custrecord_servicechg_new_price": "11",
        "custrecord_servicechg_new_price_text": null,
        "custrecord_servicechg_new_freq": "4,5",
        "custrecord_servicechg_new_freq_text": "Fri,Thu",
        "custrecord_servicechg_new_zee": "",
        "custrecord_servicechg_new_zee_text": "",
        "custrecord_servicechg_date_ceased": "",
        "custrecord_servicechg_date_ceased_text": null,
        "custrecord_servicechg_comm_reg": "44524",
        "custrecord_servicechg_comm_reg_text": "44524",
        "custrecord_default_servicechg_record": "1",
        "custrecord_default_servicechg_record_text": "Yes",
        "custrecord_service_customer": "1734126",
        "custrecord_service_customer_text": "71183331 Test02 TN 16/02/2023",
        "custrecord_service_franchisee": "779884",
        "custrecord_service_franchisee_text": "TEST - NSW",
        "custrecord_service_category": "1",
        "custrecord_service_category_text": "Services",
        "custrecord_service": "51",
        "custrecord_service_text": "AMPO 3",
        "name": "AMPO 3",
        "name_text": null,
        "custrecord_service_price": "11.00",
        "custrecord_service_price_text": null,
        "custrecord_service_package": "",
        "custrecord_service_package_text": "",
        "custrecord_service_description": "",
        "custrecord_service_description_text": null,
        "lastmodified": "4/10/2023 9:48 AM",
        "lastmodified_text": null,
        "lastmodifiedby": "1732844",
        "lastmodifiedby_text": "Tim Nguyen",
        "created": "27/9/2023 12:00 PM",
        "created_text": null,
        "custrecord_servicechg_created": "1732844",
        "custrecord_servicechg_created_text": "Tim Nguyen",
        "custrecord_service_day_fri": true,
        "custrecord_service_day_fri_text": null,
        "custrecord_service_day_mon": false,
        "custrecord_service_day_mon_text": null,
        "custrecord_service_day_adhoc": false,
        "custrecord_service_day_adhoc_text": null,
        "custrecord_service_day_thu": true,
        "custrecord_service_day_thu_text": null,
        "custrecord_service_day_tue": false,
        "custrecord_service_day_tue_text": null,
        "custrecord_service_day_wed": false,
        "custrecord_service_day_wed_text": null,
        "custrecord_scand_form": "6626010",
        "custrecord_scand_form_text": "27/9/2023_71183331.PDF",
        "custrecord_servicechg_type": "New Customer",
        "custrecord_servicechg_type_text": null
    },
    {
        "internalid": "98181",
        "internalid_text": "98181",
        "id": "94246",
        "id_text": null,
        "custrecord_servicechg_status": "4",
        "custrecord_servicechg_status_text": "Quote",
        "custrecord_servicechg_service": "98181",
        "custrecord_servicechg_service_text": "AMDX",
        "custrecord_servicechg_date_effective": "1/12/2023",
        "custrecord_servicechg_date_effective_text": null,
        "custrecord_servicechg_date_emailed": "",
        "custrecord_servicechg_date_emailed_text": null,
        "custrecord_servicechg_new_price": "22",
        "custrecord_servicechg_new_price_text": null,
        "custrecord_servicechg_new_freq": "6",
        "custrecord_servicechg_new_freq_text": "Adhoc",
        "custrecord_servicechg_new_zee": "",
        "custrecord_servicechg_new_zee_text": "",
        "custrecord_servicechg_date_ceased": "",
        "custrecord_servicechg_date_ceased_text": null,
        "custrecord_servicechg_comm_reg": "44524",
        "custrecord_servicechg_comm_reg_text": "44524",
        "custrecord_default_servicechg_record": "1",
        "custrecord_default_servicechg_record_text": "Yes",
        "custrecord_service_customer": "1734126",
        "custrecord_service_customer_text": "71183331 Test02 TN 16/02/2023",
        "custrecord_service_franchisee": "779884",
        "custrecord_service_franchisee_text": "TEST - NSW",
        "custrecord_service_category": "1",
        "custrecord_service_category_text": "Services",
        "custrecord_service": "2",
        "custrecord_service_text": "AMDX",
        "name": "AMDX",
        "name_text": null,
        "custrecord_service_price": "22.00",
        "custrecord_service_price_text": null,
        "custrecord_service_package": "",
        "custrecord_service_package_text": "",
        "custrecord_service_description": "",
        "custrecord_service_description_text": null,
        "lastmodified": "4/10/2023 9:48 AM",
        "lastmodified_text": null,
        "lastmodifiedby": "1732844",
        "lastmodifiedby_text": "Tim Nguyen",
        "created": "29/9/2023 11:15 AM",
        "created_text": null,
        "custrecord_servicechg_created": "1732844",
        "custrecord_servicechg_created_text": "Tim Nguyen",
        "custrecord_service_day_fri": false,
        "custrecord_service_day_fri_text": null,
        "custrecord_service_day_mon": false,
        "custrecord_service_day_mon_text": null,
        "custrecord_service_day_adhoc": true,
        "custrecord_service_day_adhoc_text": null,
        "custrecord_service_day_thu": false,
        "custrecord_service_day_thu_text": null,
        "custrecord_service_day_tue": false,
        "custrecord_service_day_tue_text": null,
        "custrecord_service_day_wed": false,
        "custrecord_service_day_wed_text": null,
        "custrecord_scand_form": "6626010",
        "custrecord_scand_form_text": "27/9/2023_71183331.PDF",
        "custrecord_servicechg_type": "New Customer",
        "custrecord_servicechg_type_text": null
    }
]

import http from "@/utils/http";

const state = {
    serviceChanges: [],
    services: [],
    scheduledChanges: [],
    busy: false,
    serviceChangeIdToDelete: null,
    modal: {
        defaults: {
            internalid: null,
            service_internalid: null,
            custrecord_servicechg_date_effective: '', // Effective Date
            custrecord_servicechg_type: '', // Sales Type
            custrecord_service: '', // Service Type ID
            custrecord_service_description: '', // Description
            custrecord_service_price: 0, // Price/Old Price
            custrecord_servicechg_new_price: '', // New Price
            custrecord_servicechg_new_freq: '', // New Frequency

            custrecord_service_day_adhoc: false,
            custrecord_service_day_daily: false,
            custrecord_service_day_mon: false,
            custrecord_service_day_tue: false,
            custrecord_service_day_wed: false,
            custrecord_service_day_thu: false,
            custrecord_service_day_fri: false,
        },
        form: {},
        open: false,
        busy: false,
        minEffectiveDate: new Date(),
        globalEffectiveDate: new Date(new Date().setDate(new Date().getDate() + 1)),
        oldGlobalEffectiveDate: new Date(new Date().setDate(new Date().getDate() + 1)),
    }
};

state.modal.form = {...state.modal.defaults};

const getters = {
    services : state => state.services.filter(item => !state.serviceChanges.map(i => i['custrecord_servicechg_service']).includes(item.internalid)),
    serviceChanges : state => state.serviceChanges,
    modal : state => state.modal,
    busy : state => state.busy,
    serviceChangeIdToDelete : state => state.serviceChangeIdToDelete,
    hasScheduledChanges : state => !!state.scheduledChanges.length,
    tableData : state => [...state.serviceChanges, ...state.services.map(item => ({...item, isService: true}))],

    excludedServiceTypes : state => state.serviceChanges.map(item => item.custrecord_service),
};

const mutations = {
    openModal : (state, open = true) => { state.modal.open = open; },
    setServiceChangeIdToDelete : (state, id) => { state.serviceChangeIdToDelete = id; },
    resetForm : state => {
        state.modal.form = {...state.modal.defaults};
    },
    setGlobalEffectiveDateByISOString : (state, str) => {
        state.modal.globalEffectiveDate = _parseIsoDatetime(str, true);
    }
};

const actions = {
    init : async context => {
        if (!context.rootGetters['customerId']) return;

        context.state.busy = true;

        await _getServiceChangesAndServices(context);

        _initGlobalEffectiveDate(context);

        await _getExistingScheduledChanges(context);

        // Set the default sales type to be the same as the Commencement Register
        let index = context.rootGetters['misc/salesTypes']
            .findIndex(item => parseInt(item.value) === parseInt(context.rootGetters['comm-reg/details'].custrecord_sale_type));
        context.state.modal.defaults.custrecord_servicechg_type = context.rootGetters['misc/salesTypes'][index]?.text || '';

        context.commit('resetForm');

        context.state.busy = false;
    },
    openFormModal : (context, index) => {
        if (index >= 0) {
            let item = {...context.getters['tableData'][index]};
            let tempArr = ['mon', 'tue', 'wed', 'thu', 'fri'];

            for (let fieldId in context.state.modal.defaults)
                context.state.modal.form[fieldId] = item[fieldId];

            context.state.modal.form.internalid = item.isService ? null : item.id;
            context.state.modal.form.service_internalid = item.isService ? item.internalid : null;
            if (item.isService) context.state.modal.form.custrecord_servicechg_type = context.state.modal.defaults.custrecord_servicechg_type;

            context.state.modal.form.custrecord_servicechg_date_effective = item.isService ?
                context.state.modal.globalEffectiveDate :
                _parseDateStringIntoObject(item.custrecord_servicechg_date_effective);

            context.state.modal.form.custrecord_service_day_daily =
                tempArr.reduce((acc, val) => acc && context.state.modal.form['custrecord_service_day_' + val], true);
        } else context.commit('resetForm');

        let tmr = new Date();
        tmr.setDate(tmr.getDate() + 1);

        context.state.modal.minEffectiveDate = tmr;
        context.state.modal.open = true;
    },
    updateFrequencyCheckboxes : (context, lastClick) => {
        let form = context.state.modal.form;
        let tempArr = ['mon', 'tue', 'wed', 'thu', 'fri', 'daily', 'adhoc'];

        if (lastClick === 'adhoc' && form['custrecord_service_day_adhoc'])
            tempArr.filter(item => item !== 'adhoc').forEach(item => { form['custrecord_service_day_' + item] = false;})
        else {
            form.custrecord_service_day_adhoc = false;

            if (lastClick === 'daily' && form['custrecord_service_day_daily'])
                tempArr.filter(item => item !== 'adhoc').forEach(item => { form['custrecord_service_day_' + item] = true;})
            else {
                form['custrecord_service_day_daily'] = tempArr.filter(item => !['daily', 'adhoc'].includes(item))
                    .reduce((acc, val) => acc && context.state.modal.form['custrecord_service_day_' + val], true);
            }
        }
    },
    applyGlobalEffectiveDate : async context => {
        context.commit('displayBusyGlobalModal', {title: 'Processing...',
            message: 'Applying new global effective date to all existing service changes. Please wait...'}, {root: true});

        try {
            context.state.modal.defaults.custrecord_servicechg_date_effective = context.state.modal.globalEffectiveDate;

            await http.post('updateEffectiveDateForAll', {
                commRegId: context.rootGetters['commRegId'],
                effectiveDate: context.state.modal.globalEffectiveDate
            });

            await _getServiceChangesAndServices(context);
        } catch (e) { console.error(e); }

        context.commit('displayInfoGlobalModal', {title: 'Complete',
            message: 'New effective date has been applied to all existing service changes.', persistent: true}, {root: true});
    },
    makeGlobalEffectiveDateDefault : context => {
        context.state.modal.defaults.custrecord_servicechg_date_effective = context.state.modal.globalEffectiveDate;
        _getExistingScheduledChanges(context).then();
    },
    delete : async (context) => {
        if (!context.state.serviceChangeIdToDelete) return;

        context.commit('displayBusyGlobalModal', {title: 'Processing...', message: 'Removing service change. Please wait...'}, {root: true});

        try {
            await http.post('deleteServiceChangeRecord', {serviceChangeId: context.state.serviceChangeIdToDelete});
            await _getServiceChangesAndServices(context);
        } catch (e) { console.error(e); }

        context.commit('displayInfoGlobalModal', {title: 'Complete', message: 'Service change has been removed.', persistent: true}, {root: true});
    },
    saveServiceChange : async context => {
        if (!context.rootGetters['customerId']) return;

        context.commit('displayBusyGlobalModal', {title: 'Processing...', message: 'Saving service change. Please wait...'}, {root: true});

        try {
            context.state.modal.form.custrecord_servicechg_type_id = context.rootGetters['misc/salesTypes']
                .filter(item => item.text === context.state.modal.form.custrecord_servicechg_type)[0].value;

            context.state.modal.form.custrecord_service_text = context.rootGetters['misc/serviceTypes']
                .filter(item => item.value === context.state.modal.form.custrecord_service)[0].text;

            let data = JSON.parse(JSON.stringify(context.state.modal.form));

            let {commRegId} = await http.post('saveServiceChangeRecord', {
                customerId: context.rootGetters['customerId'],
                commRegId: context.rootGetters['commRegId'],
                data,

                salesRecordId: context.rootGetters['salesRecordId'],
                extraParams: {
                    expSendEmail: context.rootGetters['extraParams'].sendEmail,
                    expClosedWon: context.rootGetters['extraParams'].closedWon
                },
            });

            // set commRegId if it was previous null due to customer being new
            if (!context.rootGetters['commRegId']) context.commit('comm-reg/setId', commRegId, {root: true});

            await _getServiceChangesAndServices(context);

            context.dispatch('customer/init', null, {root: true}).then();

            context.state.modal.open = false;

            context.commit('displayInfoGlobalModal', {title: 'Complete', message: 'Service change has been saved.', persistent: true}, {root: true});
        } catch (e) { console.error(e); }
    }
};

// Retrieve service change records as well as service records
async function _getServiceChangesAndServices(context) {
    try {
        context.state.services = await http.get('getAssignedServices', {
            customerId: context.rootGetters['customerId']
        });

        if (context.rootGetters['commRegId']) {
            context.state.serviceChanges = await http.get('getServiceChanges', {
                commRegId: context.rootGetters['commRegId']
            });
        }
    } catch (e) { console.error(e); }
}

// Retrieve existing scheduled changes. If this result in a non-0 array, that means there are already scheduled changes.
async function _getExistingScheduledChanges(context) {
    if (Object.prototype.toString.call(context.state.modal.globalEffectiveDate) !== '[object Date]') return;

    try {
        context.state.scheduledChanges = await http.get('getScheduledServiceChanges', {
            customerId: context.rootGetters['customerId'],
            commRegId: context.rootGetters['commRegId'],
            dateEffective: context.state.modal.globalEffectiveDate,
        });
    } catch (e) { console.error(e); }
}

// Set the initial value for global effective date based on data retrieved from NetSuite
function _initGlobalEffectiveDate(context) {
    if (context.rootGetters['commRegId'])
        context.state.modal.globalEffectiveDate = _parseIsoDatetime(context.rootGetters['comm-reg/details'].custrecord_comm_date, true)

    console.log(context.state.modal.globalEffectiveDate);
    let tmr = new Date();
    tmr.setDate(tmr.getDate() + 1);
    tmr.setHours(0, 0, 0, 0);

    context.state.modal.minEffectiveDate = tmr;

    if (!context.state.modal.globalEffectiveDate || context.state.modal.globalEffectiveDate < tmr)
        context.state.modal.globalEffectiveDate = tmr;

    context.state.modal.defaults.custrecord_servicechg_date_effective = context.state.modal.globalEffectiveDate;
    context.state.modal.oldGlobalEffectiveDate = context.state.modal.globalEffectiveDate;
}

// Assuming that the input string is DD/MM/YYYY
// Converting it to ISO format (YYYY-MM-DD)
function _parseDateStringIntoObject(dateString) {
    // If dateString is not a string then we return itself without any modification
    return !!dateString && Object.prototype.toString.call(dateString) === '[object String]' ?
        new Date(dateString.split('/').reverse().join('-')) : dateString;
}

function _parseIsoDatetime(dateString, dateOnly = false) {
    let tmp = dateString.split(/[: T-]/).map(parseFloat);
    return dateOnly ?
        new Date(tmp[0], tmp[1] - 1, tmp[2], (new Date().getTimezoneOffset()/-60) + 1, 0, 0, 0) :
        new Date(tmp[0], tmp[1] - 1, tmp[2], tmp[3] || 0, tmp[4] || 0, tmp[5] || 0, 0);
}

export default {
    state,
    getters,
    actions,
    mutations
};